<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Croutons Graph – Admin Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    code { font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; }
  </style>
</head>
<body class="bg-[#F8F8F8] min-h-screen">
  <section class="w-full bg-white py-24 px-8">
    <div class="max-w-6xl mx-auto">
      <div class="text-center mb-16">
        <h1 class="text-4xl md:text-5xl font-bold text-[#0A0A0A] mb-4">
          Croutons Graph – Admin Dashboard
        </h1>
      </div>

      <section id="kpis" class="mb-8">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <div class="border-2 border-[#0A0A0A] p-8 hover:bg-[#F8F8F8] transition-colors duration-200">
            <div class="space-y-2">
              <div class="text-sm font-mono text-[#6B6B6B] uppercase tracking-wider">
                Croutons
              </div>
              <div id="kpi-croutons" class="text-4xl font-bold text-[#0A0A0A]">–</div>
            </div>
          </div>
          <div class="border-2 border-[#0A0A0A] p-8 hover:bg-[#F8F8F8] transition-colors duration-200">
            <div class="space-y-2">
              <div class="text-sm font-mono text-[#6B6B6B] uppercase tracking-wider">
                Triples
              </div>
              <div id="kpi-triples" class="text-4xl font-bold text-[#0A0A0A]">–</div>
            </div>
          </div>
          <div class="border-2 border-[#0A0A0A] p-8 hover:bg-[#F8F8F8] transition-colors duration-200">
            <div class="space-y-2">
              <div class="text-sm font-mono text-[#6B6B6B] uppercase tracking-wider">
                Server Time
              </div>
              <div id="kpi-time" class="text-2xl font-bold text-[#0A0A0A]">–</div>
            </div>
          </div>
        </div>
      </section>

      <section class="border-2 border-[#0A0A0A] p-8 mb-8">
        <h2 class="text-2xl font-bold text-[#0A0A0A] mb-6">Ingestion Monitor</h2>
        <div class="flex gap-3 flex-wrap items-center">
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Window (minutes)</label>
            <input id="ing-minutes" type="number" min="1" max="1440" value="60" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Limit</label>
            <input id="ing-limit" type="number" min="1" max="500" value="50" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div class="self-end"><button id="ing-run" class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer">Run</button></div>
        </div>
        <div id="ing-results" class="mt-3"></div>
      </section>

      <section class="border-2 border-[#0A0A0A] p-8 mb-8">
        <h2 class="text-2xl font-bold text-[#0A0A0A] mb-6">Search Croutons</h2>
        <div class="flex gap-3 flex-wrap items-center">
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Text</label>
            <input id="c-text" type="text" placeholder="contains…" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Source URL</label>
            <input id="c-url" type="text" placeholder="contains…" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Limit</label>
            <input id="c-limit" type="number" min="1" max="200" value="50" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">&nbsp;</label>
            <label class="flex items-center gap-2"><input id="c-newest" type="checkbox" checked class="w-4 h-4" /> <span class="text-sm text-[#0A0A0A]">Newest first</span></label>
          </div>
          <div class="self-end"><button id="c-run" class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer">Search</button></div>
        </div>
        <div id="c-results" class="mt-3"></div>
      </section>

      <section class="border-2 border-[#0A0A0A] p-8 mb-8">
        <h2 class="text-2xl font-bold text-[#0A0A0A] mb-6">Search Triples</h2>
        <div class="flex gap-3 flex-wrap items-center">
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Subject</label>
            <input id="t-subj" type="text" placeholder="contains…" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Predicate</label>
            <input id="t-pred" type="text" placeholder="contains…" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Object</label>
            <input id="t-obj" type="text" placeholder="contains…" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Limit</label>
            <input id="t-limit" type="number" min="1" max="200" value="50" class="border-2 border-[#0A0A0A] rounded-lg px-3 py-2 min-w-[200px]" />
          </div>
          <div>
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">&nbsp;</label>
            <label class="flex items-center gap-2"><input id="t-newest" type="checkbox" checked class="w-4 h-4" /> <span class="text-sm text-[#0A0A0A]">Newest first</span></label>
          </div>
          <div class="self-end"><button id="t-run" class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer">Search</button></div>
        </div>
        <div id="t-results" class="mt-3"></div>
      </section>

      <section class="border-2 border-[#0A0A0A] p-8 mb-8">
        <h2 class="text-2xl font-bold text-[#0A0A0A] mb-6">HMAC Validator</h2>
        <div class="flex gap-3 flex-wrap items-start">
          <div class="flex-1 min-w-[280px]">
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Payload (raw)</label>
            <textarea id="hv-payload" rows="5" class="w-full border-2 border-[#0A0A0A] rounded-lg px-3 py-2" placeholder='{"crouton_id":"t1","source_url":"https://ex.com","text":"hello"}'></textarea>
          </div>
          <div class="min-w-[220px]">
            <label class="text-xs font-mono text-[#6B6B6B] block mb-1">Computed Signature</label>
            <input id="hv-sig" type="text" class="w-full border-2 border-[#0A0A0A] rounded-lg px-3 py-2" readonly />
            <div class="flex gap-2 mt-2">
              <button id="hv-compute" class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer">Compute</button>
              <button id="hv-echo" class="px-6 py-2 border-2 border-[#0A0A0A] text-[#0A0A0A] font-medium hover:bg-[#0A0A0A] hover:text-white transition-colors duration-200 rounded-lg cursor-pointer">Compare with /diag/echo</button>
            </div>
            <small class="text-sm text-[#6B6B6B] block mt-2">Sends X-Signature to <code class="bg-[#F8F8F8] px-1 py-0.5 rounded">/diag/echo</code> and checks equality.</small>
          </div>
        </div>
        <div id="hv-result" class="mt-3"></div>
      </section>

      <section class="border-2 border-[#0A0A0A] p-8 mb-8">
        <h2 class="text-2xl font-bold text-[#0A0A0A] mb-6">Raw Feeds</h2>
        <div class="flex gap-3 flex-wrap items-center">
          <button id="show-croutons" class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer">GET /feeds/croutons.ndjson</button>
          <button id="show-graph" class="px-6 py-2 bg-[#0A0A0A] text-white font-medium hover:bg-[#00C2FF] transition-colors duration-200 rounded-lg cursor-pointer">GET /feeds/graph.json</button>
        </div>
        <pre id="raw-output" class="mt-3 bg-[#0A0A0A] text-white p-3 rounded-lg overflow-auto whitespace-pre-wrap"></pre>
      </section>
    </div>
  </section>

  <script>
    async function loadStats() {
      const r = await fetch("/diag/stats");
      const j = await r.json();
      document.getElementById("kpi-croutons").textContent = j.counts.croutons;
      document.getElementById("kpi-triples").textContent  = j.counts.triples;
      document.getElementById("kpi-time").textContent     = j.time;
    }

    function table(headers, rows) {
      const thead = "<tr>" + headers.map(h => "<th class='border-b-2 border-[#0A0A0A] p-2 text-left font-bold text-[#0A0A0A]'>" + h + "</th>").join("") + "</tr>";
      const body = rows.map(r => "<tr class='hover:bg-[#F8F8F8] transition-colors duration-200'>" + r.map(c => "<td class='border-b border-[#0A0A0A]/20 p-2 text-left text-[#0A0A0A]'>" + (c == null ? "" : c) + "</td>").join("") + "</tr>").join("");
      return "<table class='w-full border-collapse text-sm mt-3'><thead>" + thead + "</thead><tbody>" + body + "</tbody></table>";
    }

    async function runIngestion() {
      const minutes = document.getElementById("ing-minutes").value || "60";
      const limit = document.getElementById("ing-limit").value || "50";
      const r = await fetch(`/admin/ingestion/recent?minutes=${encodeURIComponent(minutes)}&limit=${encodeURIComponent(limit)}`);
      const j = await r.json();
      const rows = (j.items || []).map(x => [x.crouton_id || "", x.source_url || "", x.text || "", x.created_at || ""]);
      document.getElementById("ing-results").innerHTML =
        `<div class="text-sm text-[#6B6B6B] font-mono mb-2">Window: ${j.window_minutes}m · Count: ${j.count} · Now: ${j.now}</div>` +
        table(["crouton_id","source_url","text","created_at"], rows);
    }

    async function runCroutonSearch() {
      const text = document.getElementById("c-text").value || "";
      const url  = document.getElementById("c-url").value || "";
      const lim  = document.getElementById("c-limit").value || "50";
      const newest = document.getElementById("c-newest").checked ? "1" : "0";
      const qs = new URLSearchParams({ text, source_url: url, limit: lim, newest });
      const r = await fetch("/admin/search/croutons?" + qs.toString());
      const j = await r.json();
      const rows = (j.items || []).map(x => [
        x.crouton_id || "", x.source_url || "", (x.text || "").slice(0,140),
        x.triple ? JSON.stringify(x.triple) : "", x.created_at || ""
      ]);
      document.getElementById("c-results").innerHTML =
        `<div class="text-sm text-[#6B6B6B] font-mono mb-2">Results: ${j.count}</div>` +
        table(["crouton_id","source_url","text","triple","created_at"], rows);
    }

    async function runTripleSearch() {
      const subj = document.getElementById("t-subj").value || "";
      const pred = document.getElementById("t-pred").value || "";
      const obj  = document.getElementById("t-obj").value || "";
      const lim  = document.getElementById("t-limit").value || "50";
      const newest = document.getElementById("t-newest").checked ? "1" : "0";
      const qs = new URLSearchParams({ subject: subj, predicate: pred, object: obj, limit: lim, newest });
      const r = await fetch("/admin/search/triples?" + qs.toString());
      const j = await r.json();
      const rows = (j.items || []).map(x => [x.subject, x.predicate, x.object, x.evidence_crouton_id || "", x.created_at || ""]);
      document.getElementById("t-results").innerHTML =
        `<div class="text-sm text-[#6B6B6B] font-mono mb-2">Results: ${j.count}</div>` +
        table(["subject","predicate","object","evidence_crouton_id","created_at"], rows);
    }

    async function computeHmacLocal(payload) {
      // Do not expose your server secret in the browser—this is just to demo the roundtrip using /diag/echo.
      // We compute server-side signature via /diag/echo by sending the header we claim.
      // For local display we hash payload with a fake secret to show the format; we’ll let the server confirm.
      // Better: leave the local field blank and let /diag/echo do the comparison.
      return ""; // Intentionally blank, we rely on /diag/echo to validate.
    }

    async function runHmacCompute() {
      const payload = document.getElementById("hv-payload").value || "";
      // Leave hv-sig as blank unless you know the secret locally.
      document.getElementById("hv-sig").value = "";
      document.getElementById("hv-result").innerHTML = `<small class="text-sm text-[#6B6B6B] block">If you want to verify, click "Compare with /diag/echo".</small>`;
    }

    async function runHmacEcho() {
      const payload = document.getElementById("hv-payload").value || "";
      // Ask the server what the signature should be for this exact body
      const sigCalc = await fetch("/diag/ping").then(r=>r.json()).then(_=>null).catch(_=>null);
      // We can’t compute locally without the secret; we’ll send a bogus header then ask the server to calc and compare.
      // Instead, let’s fetch the server-computed signature by posting with no header and just display it.
      const r = await fetch("/diag/echo", { method: "POST", headers: { "Content-Type": "application/x-ndjson" }, body: payload });
      const j = await r.json();
      const serverSig = j.server_signature || "";
      document.getElementById("hv-sig").value = serverSig;
      const ok = (j.received_signature === serverSig) && j.matches;
      document.getElementById("hv-result").innerHTML =
        `<pre class="bg-[#F8F8F8] border-2 border-[#0A0A0A] p-3 rounded-lg overflow-auto text-sm">${JSON.stringify(j, null, 2)}</pre>` +
        (ok ? "<div class='mt-2 text-[#25D366] font-medium'>Signatures match</div>" : "<div class='mt-2 text-sm text-[#6B6B6B]'>Note: To fully validate, POST again with header <code class='bg-[#F8F8F8] px-1 py-0.5 rounded'>X-Signature: "
        + serverSig + "</code> and the exact same payload body (including newline semantics).</div>");
    }

    async function showFeed(path) {
      const r = await fetch(path);
      const text = await r.text();
      document.getElementById("raw-output").textContent = text.slice(0, 30000);
    }

    // Wire up
    document.getElementById("ing-run").addEventListener("click", runIngestion);
    document.getElementById("c-run").addEventListener("click", runCroutonSearch);
    document.getElementById("t-run").addEventListener("click", runTripleSearch);
    document.getElementById("hv-compute").addEventListener("click", runHmacCompute);
    document.getElementById("hv-echo").addEventListener("click", runHmacEcho);
    document.getElementById("show-croutons").addEventListener("click", () => showFeed("/feeds/croutons.ndjson?nocache=1"));
    document.getElementById("show-graph").addEventListener("click", () => showFeed("/feeds/graph.json?nocache=1"));

    loadStats();
    runIngestion();
  </script>
</body>
</html>